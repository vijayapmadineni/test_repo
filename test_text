WITH temp_table AS (
    SELECT 
        CONCAT_WS('~', p_num, n_num, 
            CASE WHEN EXTRACT(QUARTER FROM NOW()) = 1 
                 THEN EXTRACT(YEAR FROM NOW()) - 1 
                 ELSE EXTRACT(YEAR FROM NOW()) 
            END, 
            CASE WHEN EXTRACT(QUARTER FROM NOW()) = 1 
                 THEN 4 
                 ELSE EXTRACT(QUARTER FROM NOW()) - 1 
            END
        ) AS id, 
        p_num, 
        n_num 
    FROM table1
),
last_quarter_data AS (
    SELECT 
        t2.id
    FROM table2 t2
    JOIN temp_table tt ON t2.id = tt.id
    JOIN table3 t3 ON t3.id = tt.id
    WHERE t3.status = 'pending'
    AND t3.created_date BETWEEN
        -- Start date of the last 14 days of the previous quarter
        CASE 
            WHEN EXTRACT(QUARTER FROM NOW()) = 1 THEN 
                DATE_TRUNC('quarter', DATE_TRUNC('year', NOW()) - INTERVAL '1 day') - INTERVAL '13 days'
            ELSE 
                DATE_TRUNC('quarter', NOW() - INTERVAL '3 months') + INTERVAL '2 months' + INTERVAL '17 days'
        END
    AND
        -- End date of the last 14 days of the previous quarter
        CASE 
            WHEN EXTRACT(QUARTER FROM NOW()) = 1 THEN 
                DATE_TRUNC('quarter', DATE_TRUNC('year', NOW()) - INTERVAL '1 day')
            ELSE 
                DATE_TRUNC('quarter', NOW() - INTERVAL '3 months') + INTERVAL '2 months' + INTERVAL '30 days'
        END
)
