import os
from smbprotocol.connection import Connection, Dialects
from smbprotocol.session import Session
from smbprotocol.open import Open, CreateDisposition, FileAttributes, CreateOptions

# SMB server details
host = "my-host-1"
username = "user_sam"
password = "pass_sam"
share_name = "folder1"
directory = "folder2"

# Establish connection to the SMB server
connection = Connection(uuid.uuid4(), host, port=445)
connection.connect(Dialects.SMB_3_1_1)
session = Session(connection, username, password)
session.connect()

# Connect to the share
share = Open(session, share_name)
share.create(
    CreateDisposition.FILE_OPEN_IF,
    FileAttributes.FILE_ATTRIBUTE_DIRECTORY,
    CreateOptions.FILE_DIRECTORY_FILE
)

# Navigate to the desired directory
folder = Open(share, directory)
folder.create(
    CreateDisposition.FILE_OPEN_IF,
    FileAttributes.FILE_ATTRIBUTE_DIRECTORY,
    CreateOptions.FILE_DIRECTORY_FILE
)

# List and filter files
files = folder.list_directory()
for file_info in files:
    file_name = file_info['file_name'].decode()
    print("Found file:", file_name)
    if file_name.startswith(("aaa_user", "bbb_user")) and file_name.endswith(".csv"):
        print("Downloading:", file_name)
        # Open the file for reading
        file_to_download = Open(folder, file_name)
        file_to_download.create(
            CreateDisposition.FILE_OPEN,
            FileAttributes.FILE_ATTRIBUTE_NORMAL,
            CreateOptions.FILE_NON_DIRECTORY_FILE
        )
        # Read and save the file locally
        file_data = file_to_download.read()
        with open(file_name, 'wb') as f:
            f.write(file_data)

# Clean up resources
file_to_download.close()
folder.close()
share.close()
session.disconnect()
connection.disconnect()

###############################################################################################################################################
import uuid
from smbprotocol.connection import Connection, Dialects
from smbprotocol.session import Session
from smbprotocol.tree import TreeConnect
from smbprotocol.file import CreateDisposition, FileAttributes, Open

# SMB server details
host = "my-host-1"
share_name = "\\folder1\\folder2"  # Use the full path from the root to your specific folder
username = "user_sam"
password = "pass_sam"
domain = "DOMAIN"  # Update with your domain if needed, or use ""

# Establish connection to the SMB server
connection = Connection(uuid.uuid4(), host, 445)
connection.connect(Dialects.SMB_3_1_1)

session = Session(connection, username, password, domain)
session.connect()

tree = TreeConnect(session, share_name)
tree.connect()

# Now you can open files, list directories, etc., within the 'tree' object context
# Example of listing a directory
directory = Open(tree, share_name, create_options=CreateOptions.FILE_DIRECTORY_FILE,
                 desired_access=FileAccess.FILE_READ_DATA, share_access=ShareAccess.FILE_SHARE_READ,
                 create_disposition=CreateDisposition.FILE_OPEN, file_attributes=FileAttributes.FILE_ATTRIBUTE_DIRECTORY)
directory.create()

# Here you would continue with listing files, filtering, and downloading them.

