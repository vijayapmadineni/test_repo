import os
from smbprotocol.connection import Connection, Dialects
from smbprotocol.session import Session
from smbprotocol.open import Open, CreateDisposition, FileAttributes, CreateOptions

# SMB server details
host = "my-host-1"
username = "user_sam"
password = "pass_sam"
share_name = "folder1"
directory = "folder2"

# Establish connection to the SMB server
connection = Connection(uuid.uuid4(), host, port=445)
connection.connect(Dialects.SMB_3_1_1)
session = Session(connection, username, password)
session.connect()

# Connect to the share
share = Open(session, share_name)
share.create(
    CreateDisposition.FILE_OPEN_IF,
    FileAttributes.FILE_ATTRIBUTE_DIRECTORY,
    CreateOptions.FILE_DIRECTORY_FILE
)

# Navigate to the desired directory
folder = Open(share, directory)
folder.create(
    CreateDisposition.FILE_OPEN_IF,
    FileAttributes.FILE_ATTRIBUTE_DIRECTORY,
    CreateOptions.FILE_DIRECTORY_FILE
)

# List and filter files
files = folder.list_directory()
for file_info in files:
    file_name = file_info['file_name'].decode()
    print("Found file:", file_name)
    if file_name.startswith(("aaa_user", "bbb_user")) and file_name.endswith(".csv"):
        print("Downloading:", file_name)
        # Open the file for reading
        file_to_download = Open(folder, file_name)
        file_to_download.create(
            CreateDisposition.FILE_OPEN,
            FileAttributes.FILE_ATTRIBUTE_NORMAL,
            CreateOptions.FILE_NON_DIRECTORY_FILE
        )
        # Read and save the file locally
        file_data = file_to_download.read()
        with open(file_name, 'wb') as f:
            f.write(file_data)

# Clean up resources
file_to_download.close()
folder.close()
share.close()
session.disconnect()
connection.disconnect()

###############################################################################################################################################
import os
import uuid
from smbprotocol.connection import Connection, Dialects
from smbprotocol.session import Session
from smbprotocol.tree import TreeConnect
from smbprotocol.open import Open, CreateDisposition, CreateOptions, FileAccess, ShareAccess
from smbprotocol.file_info import FileAttributes

# Connection parameters
hostname = "my-host-1"
username = "user_sam"
password = "pass_sam"
share_name = "share"  # Adjust the share name to your SMB share
directory = "\\folder1\\folder2"  # Use the correct path

# Establish a connection
connection = Connection(uuid.uuid4(), hostname, port=445)
connection.connect(Dialects.SMB_3_1_1)

session = Session(connection, username, password)
session.connect()

tree = TreeConnect(session, f"\\\\{hostname}\\{share_name}")
tree.connect()

# Open the directory
directory_path = Open(tree, directory, create_options=CreateOptions.FILE_DIRECTORY_FILE,
                      desired_access=FileAccess.FILE_LIST_DIRECTORY, share_access=ShareAccess.FILE_SHARE_READ,
                      create_disposition=CreateDisposition.FILE_OPEN, file_attributes=FileAttributes.FILE_ATTRIBUTE_DIRECTORY)
directory_path.create()

# List all files and download specific files
files = directory_path.query_directory("*", file_information_class="FileDirectoryInformation")
for file_info in files:
    file_name = file_info.file_name
    print("Found file:", file_name)
    if file_name.startswith(("aaa_user", "bbb_user")) and file_name.endswith(".csv"):
        print("Downloading:", file_name)
        file_to_download = Open(tree, os.path.join(directory, file_name), desired_access=FileAccess.FILE_READ_DATA)
        file_to_download.create()
        file_contents = file_to_download.read()
        with open(file_name, 'wb') as f:
            f.write(file_contents)
        file_to_download.close()

# Clean up
directory_path.close()
tree.disconnect()
session.logoff()
connection.disconnect()


